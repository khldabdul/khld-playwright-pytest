# Nightly Regression - Full Test Suite
# Runs complete test suite every night

name: Nightly Regression

on:
  schedule:
    - cron: '0 2 * * *'  # 2 AM UTC daily
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  ALLURE_VERSION: '2.25.0'

jobs:
  regression:
    name: Full Regression Suite
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    strategy:
      fail-fast: false
      matrix:
        suite:
          - e2e
          - api
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Install Playwright browsers (E2E only)
        if: matrix.suite == 'e2e'
        run: |
          playwright install chromium --with-deps
      
      - name: Install Allure
        run: |
          wget -q https://github.com/allure-framework/allure2/releases/download/${{ env.ALLURE_VERSION }}/allure-${{ env.ALLURE_VERSION }}.tgz
          tar -xzf allure-${{ env.ALLURE_VERSION }}.tgz
          echo "$PWD/allure-${{ env.ALLURE_VERSION }}/bin" >> $GITHUB_PATH
      
      - name: Run ${{ matrix.suite }} tests
        env:
          OMDB_API_KEY: ${{ secrets.OMDB_API_KEY }}
        run: |
          pytest apps/${{ matrix.suite }}/ \
            --alluredir=allure-results \
            -v \
            -n auto \
            --video=retain-on-failure \
            --screenshot=only-on-failure
      
      - name: Generate Allure report
        if: always()
        run: |
          allure generate allure-results --clean -o allure-report
      
      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.suite }}-regression-report
          path: allure-report/
          retention-days: 7
  
  notify:
    name: Send Notification
    runs-on: ubuntu-latest
    needs: regression
    if: always()
    
    steps:
      - name: Create summary
        run: |
          echo "## Nightly Regression Results ðŸŒ™" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Regression suite completed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- E2E: ${{ needs.regression.outputs.e2e-status || 'Unknown' }}" >> $GITHUB_STEP_SUMMARY
          echo "- API: ${{ needs.regression.outputs.api-status || 'Unknown' }}" >> $GITHUB_STEP_SUMMARY
