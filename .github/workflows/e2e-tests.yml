# E2E Tests with Playwright and Allure Reporting
# Reports are deployed to VPS after test completion

name: E2E Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      app:
        description: 'App to test (leave empty for all)'
        required: false
        default: ''
      environment:
        description: 'Test environment'
        required: false
        default: 'dev'
        type: choice
        options:
          - dev
          - staging
      browser:
        description: 'Browser to use'
        required: false
        default: 'chromium'
        type: choice
        options:
          - chromium
          - firefox
          - webkit

env:
  PYTHON_VERSION: '3.11'
  ALLURE_VERSION: '2.25.0'

jobs:
  test:
    name: Run E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Install Playwright browsers
        run: |
          playwright install --with-deps chromium
          playwright install --with-deps firefox
          playwright install --with-deps webkit

      - name: Install Allure
        run: |
          wget -q https://github.com/allure-framework/allure2/releases/download/${{ env.ALLURE_VERSION }}/allure-${{ env.ALLURE_VERSION }}.tgz
          tar -xzf allure-${{ env.ALLURE_VERSION }}.tgz
          echo "$PWD/allure-${{ env.ALLURE_VERSION }}/bin" >> $GITHUB_PATH

      - name: Download previous Allure history
        uses: actions/cache@v4
        with:
          path: allure-history
          key: allure-history-${{ github.ref_name }}
          restore-keys: |
            allure-history-main
            allure-history-

      - name: Run tests
        id: tests
        env:
          # Add your app-specific environment variables here
          ADMIN_PORTAL_ADMIN_PASSWORD: ${{ secrets.ADMIN_PORTAL_ADMIN_PASSWORD }}
          CUSTOMER_PORTAL_CUSTOMER_PASSWORD: ${{ secrets.CUSTOMER_PORTAL_CUSTOMER_PASSWORD }}
        run: |
          # Determine test parameters
          APP_FILTER="${{ github.event.inputs.app }}"
          ENV="${{ github.event.inputs.environment || 'dev' }}"
          BROWSER="${{ github.event.inputs.browser || 'chromium' }}"

          # Build pytest command
          PYTEST_CMD="pytest"
          PYTEST_CMD="$PYTEST_CMD --browser $BROWSER"
          PYTEST_CMD="$PYTEST_CMD --env $ENV"
          PYTEST_CMD="$PYTEST_CMD --alluredir=allure-results"
          PYTEST_CMD="$PYTEST_CMD --video=retain-on-failure"
          PYTEST_CMD="$PYTEST_CMD --screenshot=only-on-failure"
          PYTEST_CMD="$PYTEST_CMD --tracing=retain-on-failure"
          PYTEST_CMD="$PYTEST_CMD -v"

          if [ -n "$APP_FILTER" ]; then
            PYTEST_CMD="$PYTEST_CMD --app $APP_FILTER"
          fi

          echo "Running: $PYTEST_CMD"
          $PYTEST_CMD || echo "::set-output name=test_failed::true"

      - name: Copy Allure history
        if: always()
        run: |
          if [ -d "allure-history" ]; then
            cp -r allure-history/* allure-results/history/ 2>/dev/null || true
          fi

      - name: Generate Allure report
        if: always()
        run: |
          allure generate allure-results --clean -o allure-report

      - name: Copy history for next run
        if: always()
        run: |
          mkdir -p allure-history
          cp -r allure-report/history/* allure-history/ 2>/dev/null || true

      - name: Generate Playwright HTML report info
        if: always()
        run: |
          # Create a simple index for Playwright artifacts
          cat > test-results/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>Playwright Test Results</title>
            <style>
              body { font-family: system-ui; max-width: 800px; margin: 40px auto; padding: 20px; }
              h1 { color: #2e7d32; }
              .artifact { margin: 10px 0; padding: 10px; background: #f5f5f5; border-radius: 4px; }
              a { color: #1976d2; }
            </style>
          </head>
          <body>
            <h1>Playwright Test Artifacts</h1>
            <p>Generated: $(date -u +"%Y-%m-%d %H:%M:%S UTC")</p>
            <p>Branch: ${{ github.ref_name }}</p>
            <p>Commit: ${{ github.sha }}</p>
            <h2>Reports</h2>
            <div class="artifact">
              <a href="../allure-report/">ğŸ“Š Allure Report</a> - Comprehensive test report with history
            </div>
            <h2>Artifacts</h2>
            <div class="artifact">ğŸ“¸ Screenshots - Available in allure-report attachments</div>
            <div class="artifact">ğŸ¥ Videos - Available in allure-report attachments</div>
            <div class="artifact">ğŸ“‹ Traces - Available in allure-report attachments</div>
          </body>
          </html>
          EOF

      - name: Upload Allure report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report/
          retention-days: 30

      - name: Upload Playwright artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-artifacts
          path: test-results/
          retention-days: 30

      - name: Upload combined reports for deployment
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: reports-for-deployment
          path: |
            allure-report/
            test-results/
          retention-days: 7

  deploy-reports:
    name: Deploy Reports to VPS
    runs-on: ubuntu-latest
    needs: test
    if: always() && github.ref == 'refs/heads/main'

    steps:
      - name: Download reports
        uses: actions/download-artifact@v4
        with:
          name: reports-for-deployment
          path: reports/

      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_DEPLOY_PATH: ${{ secrets.VPS_DEPLOY_PATH }}
        run: |
          # Create timestamp for unique report folder
          TIMESTAMP=$(date +%Y%m%d_%H%M%S)
          REPORT_PATH="${VPS_DEPLOY_PATH}/${TIMESTAMP}"

          # Create remote directory and deploy
          ssh -i ~/.ssh/deploy_key ${VPS_USER}@${VPS_HOST} "mkdir -p ${REPORT_PATH}"

          # Upload reports
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/deploy_key" \
            reports/ \
            ${VPS_USER}@${VPS_HOST}:${REPORT_PATH}/

          # Update latest symlink
          ssh -i ~/.ssh/deploy_key ${VPS_USER}@${VPS_HOST} "
            cd ${VPS_DEPLOY_PATH}
            rm -f latest
            ln -s ${TIMESTAMP} latest

            # Keep only last 10 reports
            ls -1d */ 2>/dev/null | grep -v latest | head -n -10 | xargs -r rm -rf
          "

          echo "::notice::Reports deployed to https://\${{ vars.REPORTS_DOMAIN }}/latest/"

      - name: Update deployment index
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          VPS_DEPLOY_PATH: ${{ secrets.VPS_DEPLOY_PATH }}
        run: |
          # Generate index.html listing all reports
          ssh -i ~/.ssh/deploy_key ${VPS_USER}@${VPS_HOST} "
            cd ${VPS_DEPLOY_PATH}
            cat > index.html << 'INDEXEOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>E2E Test Reports</title>
            <meta charset=\"UTF-8\">
            <meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">
            <style>
              * { box-sizing: border-box; }
              body { font-family: system-ui, -apple-system, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
              .container { max-width: 1000px; margin: 0 auto; }
              h1 { color: #333; border-bottom: 2px solid #4caf50; padding-bottom: 10px; }
              .latest { background: #4caf50; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
              .latest a { color: white; font-size: 1.2em; }
              .reports { display: grid; gap: 10px; }
              .report { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
              .report a { color: #1976d2; text-decoration: none; }
              .report a:hover { text-decoration: underline; }
              .meta { color: #666; font-size: 0.9em; margin-top: 5px; }
            </style>
          </head>
          <body>
            <div class=\"container\">
              <h1>ğŸ§ª E2E Test Reports</h1>
              <div class=\"latest\">
                <strong>Latest Report:</strong><br>
                <a href=\"./latest/allure-report/\">ğŸ“Š Allure Report</a> |
                <a href=\"./latest/test-results/\">ğŸ“ Artifacts</a>
              </div>
              <h2>All Reports</h2>
              <div class=\"reports\">
          INDEXEOF

            for dir in \$(ls -1d */ 2>/dev/null | grep -v latest | sort -r); do
              name=\${dir%/}
              echo \"<div class='report'>\" >> index.html
              echo \"<a href='./\${name}/allure-report/'>ğŸ“Š \${name}</a>\" >> index.html
              echo \"<span class='meta'> | <a href='./\${name}/test-results/'>Artifacts</a></span>\" >> index.html
              echo \"</div>\" >> index.html
            done

            cat >> index.html << 'INDEXEOF2'
              </div>
            </div>
          </body>
          </html>
          INDEXEOF2
          "
