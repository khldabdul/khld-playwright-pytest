# API Tests with Allure Reporting
# Runs API tests separately for faster feedback

name: API Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      app:
        description: 'API app to test (leave empty for all)'
        required: false
        default: ''
        type: choice
        options:
          - ''
          - restful_booker
          - petstore
          - omdb
          - reqres

env:
  PYTHON_VERSION: '3.11'
  ALLURE_VERSION: '2.25.0'

jobs:
  test-api:
    name: Run API Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Install Allure
        run: |
          wget -q https://github.com/allure-framework/allure2/releases/download/${{ env.ALLURE_VERSION }}/allure-${{ env.ALLURE_VERSION }}.tgz
          tar -xzf allure-${{ env.ALLURE_VERSION }}.tgz
          echo "$PWD/allure-${{ env.ALLURE_VERSION }}/bin" >> $GITHUB_PATH
      
      - name: Run API tests
        id: tests
        env:
          OMDB_API_KEY: ${{ secrets.OMDB_API_KEY }}
        run: |
          # Determine test filter
          APP_FILTER="${{ github.event.inputs.app }}"
          
          # Build pytest command
          PYTEST_CMD="pytest apps/api/"
          if [ -n "$APP_FILTER" ]; then
            PYTEST_CMD="pytest apps/api/${APP_FILTER}/"
          fi
          
          PYTEST_CMD="$PYTEST_CMD --alluredir=allure-results"
          PYTEST_CMD="$PYTEST_CMD -v"
          PYTEST_CMD="$PYTEST_CMD -n auto"  # Parallel execution
          
          echo "Running: $PYTEST_CMD"
          $PYTEST_CMD || echo "test_failed=true" >> $GITHUB_OUTPUT
      
      - name: Generate Allure report
        if: always()
        run: |
          allure generate allure-results --clean -o allure-report
      
      - name: Upload Allure report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-allure-report
          path: allure-report/
          retention-days: 30
      
      - name: Create test summary
        if: always()
        run: |
          echo "## API Test Results ðŸ§ª" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Count results from allure-results
          if [ -d "allure-results" ]; then
            PASSED=$(grep -r "\"status\": \"passed\"" allure-results/*.json 2>/dev/null | wc -l || echo "0")
            FAILED=$(grep -r "\"status\": \"failed\"" allure-results/*.json 2>/dev/null | wc -l || echo "0")
            
            echo "- âœ… Passed: $PASSED" >> $GITHUB_STEP_SUMMARY
            echo "- âŒ Failed: $FAILED" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“Š [View Allure Report](../../../actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Fail workflow if tests failed
        if: steps.tests.outputs.test_failed == 'true'
        run: exit 1
